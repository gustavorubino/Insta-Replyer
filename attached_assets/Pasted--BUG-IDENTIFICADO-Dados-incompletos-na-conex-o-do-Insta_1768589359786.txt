ğŸš¨ BUG IDENTIFICADO: Dados incompletos na conexÃ£o do Instagram

EVIDÃŠNCIA VISUAL:

ADMIN (funciona):
- Nome: GUSTAVO SILVA RUBINO âœ…
- Instagram: @gustavorubino âœ…

USUÃRIO RODOLFO (bugado):
- Nome: donettirodolfo (parece username, nÃ£o nome completo) âŒ
- Instagram: @ID: 26421104450824756 (mostra ID, nÃ£o username!) âŒ

DIAGNÃ“STICO NECESSÃRIO:

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. VERIFICAR DADOS SALVOS NO BANCO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Execute e mostre resultado COMPLETO:

SELECT 
    u.id,
    u.email,
    u.username,
    u.first_name,
    u.last_name,
    u.profile_image_url,
    ic.instagram_account_id,
    ic.instagram_username,
    ic.instagram_name,
    ic.page_id,
    ic.page_name
FROM users u
LEFT JOIN instagram_connections ic ON u.id = ic.user_id
WHERE u.email IN ('guguinha.rubino@gmail.com', 'donettirodolfo@gmail.com');

PRECISO VER:
- instagram_username estÃ¡ NULL para Rodolfo?
- instagram_name estÃ¡ NULL?
- first_name/last_name estÃ£o preenchidos?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2. VERIFICAR CÃ“DIGO DO OAUTH CALLBACK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Mostre o cÃ³digo que busca os dados do Instagram apÃ³s OAuth.

Deve estar fazendo algo assim:

// ApÃ³s obter o token, buscar dados do usuÃ¡rio Instagram
const igUserResponse = await fetch(
  `https://graph.facebook.com/v18.0/me/accounts?access_token=${accessToken}`
);

// Depois buscar o Instagram Business Account
const igAccountResponse = await fetch(
  `https://graph.facebook.com/v18.0/${pageId}?fields=instagram_business_account&access_token=${pageToken}`
);

// Depois buscar dados do Instagram (USERNAME, NAME, etc)
const igProfileResponse = await fetch(
  `https://graph.facebook.com/v18.0/${instagramAccountId}?fields=id,username,name,profile_picture_url&access_token=${accessToken}`
);

// SALVAR TODOS OS CAMPOS:
await db.query(`
  UPDATE instagram_connections SET
    instagram_account_id = $1,
    instagram_username = $2,    -- â† CRÃTICO!
    instagram_name = $3,
    profile_picture_url = $4
  WHERE user_id = $5
`, [instagramAccountId, username, name, profilePic, userId]);

VERIFIQUE:
- O cÃ³digo estÃ¡ buscando o campo "username" da API?
- EstÃ¡ salvando no campo instagram_username?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
3. BUSCAR USERNAME DO RODOLFO AGORA (CORREÃ‡ÃƒO IMEDIATA)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

O Rodolfo jÃ¡ tem o token vÃ¡lido. Podemos buscar o username agora:

// Buscar token do Rodolfo
const rodolfoToken = await db.query(`
  SELECT access_token, instagram_account_id 
  FROM instagram_connections ic
  JOIN users u ON ic.user_id = u.id
  WHERE u.email = 'donettirodolfo@gmail.com'
`);

// Buscar dados do Instagram
const response = await fetch(
  `https://graph.facebook.com/v18.0/${rodolfoToken.instagram_account_id}?fields=id,username,name,profile_picture_url&access_token=${rodolfoToken.access_token}`
);

const igData = await response.json();
console.log('Dados do Instagram do Rodolfo:', igData);

// Se retornar username, atualizar no banco:
await db.query(`
  UPDATE instagram_connections SET
    instagram_username = $1,
    instagram_name = $2
  WHERE instagram_account_id = $3
`, [igData.username, igData.name, rodolfoToken.instagram_account_id]);

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
4. CORRIGIR OAUTH PARA FUTUROS USUÃRIOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

No callback do OAuth, GARANTIR que busca e salva:
- instagram_username (ex: "rodolfodonetti")
- instagram_name (ex: "Rodolfo Donetti")
- profile_picture_url

CÃ³digo correto:

async function fetchInstagramProfile(instagramAccountId, accessToken) {
  const response = await fetch(
    `https://graph.facebook.com/v18.0/${instagramAccountId}?fields=id,username,name,profile_picture_url&access_token=${accessToken}`
  );
  
  if (!response.ok) {
    console.error('Erro ao buscar perfil Instagram:', await response.text());
    return null;
  }
  
  return await response.json();
}

// No OAuth callback, apÃ³s obter o instagram_account_id:
const igProfile = await fetchInstagramProfile(instagramAccountId, accessToken);

if (igProfile) {
  await db.query(`
    UPDATE instagram_connections SET
      instagram_username = $1,
      instagram_name = $2,
      profile_picture_url = $3
    WHERE user_id = $4
  `, [
    igProfile.username,    // "rodolfodonetti"
    igProfile.name,        // "Rodolfo Donetti"
    igProfile.profile_picture_url,
    userId
  ]);
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
5. CORRIGIR NOME DO USUÃRIO (TABELA USERS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

O nome "donettirodolfo" parece estar errado tambÃ©m.

Verifique como o Replit Auth salva os dados do usuÃ¡rio.
O nome deveria vir do Google/provedor de autenticaÃ§Ã£o.

SELECT id, email, username, first_name, last_name 
FROM users 
WHERE email = 'donettirodolfo@gmail.com';

Se first_name e last_name estiverem vazios, o sistema estÃ¡
usando o username como fallback (comportamento errado para exibiÃ§Ã£o).

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TAREFAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–¡ 1. Mostrar dados atuais do banco (query do item 1)
â–¡ 2. Buscar e atualizar username do Rodolfo (item 3)
â–¡ 3. Corrigir OAuth callback para salvar username (item 4)
â–¡ 4. Verificar/corrigir nome do usuÃ¡rio (item 5)
â–¡ 5. Testar com novo usuÃ¡rio para confirmar que salva tudo

RESULTADO ESPERADO:

Rodolfo deve ver:
- Instagram: @rodolfodonetti (nÃ£o o ID numÃ©rico)
- Nome: Rodolfo Donetti (ou nome real dele)

MOSTRE-ME:
1. Resultado das queries
2. CÃ³digo atual do OAuth callback
3. CÃ³digo corrigido
4. ConfirmaÃ§Ã£o de que Rodolfo agora mostra @rodolfodonetti